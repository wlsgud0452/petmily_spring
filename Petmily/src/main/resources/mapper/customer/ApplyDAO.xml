<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org/DTO 3.0//EN"
						"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
						
<mapper namespace="com.petmily.customer.dao.ApplyDAO">
	
	<select id="selectCategory" resultType="Integer">
		select count(*) from apply a, posting p where a.apcompletedate is not null 
		and ( a.user_uid = #{uid} or a.posting_user_uid = #{uid} ) 
		and a.posting_pid = p.pid and p.pcategory = #{pcategory}
	</select>
	
	<select id="applyListRow" resultType="Integer">
		select count(*) from apply where posting_user_uid = #{uid} 
		and apcanceldate is null and apmatchingdate is null and apcompletedate is null
	</select>
	
	<select id="applyGetList" resultType="com.petmily.customer.dto.ApplyDTO">
		select a.apid , a.aptitle , a.apcontent, a.apdate , a.posting_pid , a.user_uid from apply a , posting p 
		where a.posting_user_uid = #{uid}
		and apcanceldate is null and apmatchingdate is null and apcompletedate is null 
		and p.pid = a.posting_pid and p.pdeletedate is null 
		order by a.apdate desc limit #{start}  , #{rowLength}
	</select>
	
	<select id="acceptListRow" resultType="Integer">
		select count(*) from apply where user_uid = #{uid} 
		and apcanceldate is null and apmatchingdate is not null and apcompletedate is null
	</select>
	
	<select id="acceptApidList" resultType="Integer">
		select apid from apply where user_uid = #{uid}
		and apcanceldate is null and apmatchingdate is not null and apcompletedate is null
		order by apmatchingdate 
	</select>
	
	<update id="updateByApId">
		update apply set ${columnname} = now() where apid = #{apid}
	</update>
	
	<update id="updateByPId">
		update apply set apcanceldate = now() where posting_pid = #{pid} and apmatchingdate is null
	</update>
	

	<select id="applyUserCount" resultType="Integer">
		select count(apid) from apply where user_uid = #{user_uid} and posting_pid = #{posting_pid}
	</select>
	
	<insert id="postingApplyInsert">
		insert into apply (user_uid, posting_pid, posting_user_uid, aptitle, apcontent, apdate) 
		values (#{user_uid},#{posting_pid},#{posting_user_uid},#{aptitle},#{apcontent},now())
	</insert>
	
</mapper>